<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Mini CAD - 2D 도형 설계</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #eaeaea;
        }

        #toolbar {
            background: #333;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-button {
            background: #555;
            border: none;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .tool-button.active {
            background: #0a84ff;
        }

        canvas {
            display: block;
            background: white;
            margin: 0 auto;
            border: 1px solid #444;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
    </style>
</head>
<body>
<div id="app">
    <div id="toolbar">
        <button class="tool-button" id="selectTool" data-tool="select">선택</button>
        <button class="tool-button" id="rectTool" data-tool="rectangle">사각형</button>
        <button class="tool-button" id="circleTool" data-tool="circle">원</button>
        <button class="tool-button" id="lineTool" data-tool="line">선</button>
    </div>
    <canvas id="canvas" width="1000" height="600"></canvas>
</div>

<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let tool = "select";

    const shapes = [];
    let isDrawing = false;
    let startX = 0, startY = 0;
    let selectedShape = null;
    let dragOffset = { x: 0, y: 0 };

    const toolButtons = document.querySelectorAll(".tool-button");
    toolButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            tool = btn.dataset.tool;
            toolButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            selectedShape = null;
        });
    });

    function drawAll() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        shapes.forEach(shape => {
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            ctx.beginPath();

            if (shape.type === "rectangle") {
                ctx.strokeRect(shape.x, shape.y, shape.width, shape.height);
            } else if (shape.type === "circle") {
                ctx.arc(shape.x, shape.y, shape.radius, 0, Math.PI * 2);
                ctx.stroke();
            } else if (shape.type === "line") {
                ctx.moveTo(shape.x1, shape.y1);
                ctx.lineTo(shape.x2, shape.y2);
                ctx.stroke();
            }

            ctx.closePath();
        });
    }

    canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        if (tool === "select") {
            selectedShape = getShapeAt(mouseX, mouseY);
            if (selectedShape) {
                if (selectedShape.type === "rectangle" || selectedShape.type === "circle") {
                    dragOffset.x = mouseX - selectedShape.x;
                    dragOffset.y = mouseY - selectedShape.y;
                } else if (selectedShape.type === "line") {
                    dragOffset.x = mouseX - selectedShape.x1;
                    dragOffset.y = mouseY - selectedShape.y1;
                }
            }
        } else {
            isDrawing = true;
            startX = mouseX;
            startY = mouseY;
        }
    });

    canvas.addEventListener("mousemove", (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        if (tool === "select" && selectedShape) {
            if (selectedShape.type === "rectangle" || selectedShape.type === "circle") {
                selectedShape.x = mouseX - dragOffset.x;
                selectedShape.y = mouseY - dragOffset.y;
            } else if (selectedShape.type === "line") {
                const dx = mouseX - dragOffset.x;
                const dy = mouseY - dragOffset.y;
                const deltaX = dx - selectedShape.x1;
                const deltaY = dy - selectedShape.y1;
                selectedShape.x1 = dx;
                selectedShape.y1 = dy;
                selectedShape.x2 += deltaX;
                selectedShape.y2 += deltaY;
            }
            drawAll();
        }
    });

    canvas.addEventListener("mouseup", (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        if (tool !== "select" && isDrawing) {
            let shape;
            if (tool === "rectangle") {
                shape = {
                    type: "rectangle",
                    x: startX,
                    y: startY,
                    width: mouseX - startX,
                    height: mouseY - startY
                };
            } else if (tool === "circle") {
                const radius = Math.sqrt(Math.pow(mouseX - startX, 2) + Math.pow(mouseY - startY, 2));
                shape = {
                    type: "circle",
                    x: startX,
                    y: startY,
                    radius: radius
                };
            } else if (tool === "line") {
                shape = {
                    type: "line",
                    x1: startX,
                    y1: startY,
                    x2: mouseX,
                    y2: mouseY
                };
            }

            if (shape) shapes.push(shape);
            isDrawing = false;
            drawAll();
        }

        selectedShape = null;
    });

    function getShapeAt(x, y) {
        for (let i = shapes.length - 1; i >= 0; i--) {
            const shape = shapes[i];
            if (shape.type === "rectangle") {
                if (x >= shape.x && x <= shape.x + shape.width &&
                    y >= shape.y && y <= shape.y + shape.height) {
                    return shape;
                }
            } else if (shape.type === "circle") {
                const dx = x - shape.x;
                const dy = y - shape.y;
                if (Math.sqrt(dx * dx + dy * dy) <= shape.radius) {
                    return shape;
                }
            } else if (shape.type === "line") {
                const distance = distanceToLine(shape.x1, shape.y1, shape.x2, shape.y2, x, y);
                if (distance < 6) {
                    return shape;
                }
            }
        }
        return null;
    }

    function distanceToLine(x1, y1, x2, y2, px, py) {
        const A = px - x1;
        const B = py - y1;
        const C = x2 - x1;
        const D = y2 - y1;

        const dot = A * C + B * D;
        const len_sq = C * C + D * D;
        let param = -1;
        if (len_sq !== 0) param = dot / len_sq;

        let xx, yy;

        if (param < 0) {
            xx = x1;
            yy = y1;
        } else if (param > 1) {
            xx = x2;
            yy = y2;
        } else {
            xx = x1 + param * C;
            yy = y1 + param * D;
        }

        const dx = px - xx;
        const dy = py - yy;
        return Math.sqrt(dx * dx + dy * dy);
    }

    drawAll();
</script>
</body>
</html>
